name: Vercel Deployment Check

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write
  statuses: write
  checks: write

jobs:
  vercel-check:
    runs-on: ubuntu-latest
    name: âœ… Verify Vercel Deployment Ready

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3ï¸âƒ£ Install dependencies
      - name: ðŸ“š Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Generate Prisma Client
      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate
        env:
          SKIP_ENV_VALIDATION: "true"

      # 5ï¸âƒ£ Verify vercel.json exists and is valid
      - name: ðŸ” Verify vercel.json Configuration
        run: |
          echo "ðŸ” Checking vercel.json..."
          if [ ! -f "vercel.json" ]; then
            echo "âŒ vercel.json not found!"
            exit 1
          fi
          echo "âœ… vercel.json found"
          
          # Validate JSON syntax
          if ! jq empty vercel.json 2>/dev/null; then
            echo "âŒ vercel.json has invalid JSON syntax!"
            exit 1
          fi
          echo "âœ… vercel.json is valid JSON"
          
          # Display configuration
          echo "ðŸ“‹ Vercel Configuration:"
          cat vercel.json | jq '.'

      # 6ï¸âƒ£ Check vercel-ignore.sh script
      - name: ðŸ” Verify Vercel Ignore Script
        run: |
          echo "ðŸ” Checking vercel-ignore.sh..."
          if [ ! -f "vercel-ignore.sh" ]; then
            echo "âŒ vercel-ignore.sh not found!"
            exit 1
          fi
          echo "âœ… vercel-ignore.sh found"
          
          # Make sure it's executable
          chmod +x vercel-ignore.sh
          echo "âœ… vercel-ignore.sh is executable"
          
          # Display script content
          echo "ðŸ“‹ Ignore Script Content:"
          cat vercel-ignore.sh

      # 7ï¸âƒ£ Test build for Vercel
      - name: ðŸ—ï¸ Test Vercel Build
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_BASE_URL: https://tec-ecosystem.vercel.app
          DATABASE_URL: postgresql://dummy:user@dummy:5432/dummy?schema=public
          NEXT_PUBLIC_PI_APP_ID: dummy_app_id
          NEXT_PUBLIC_PI_SANDBOX: "true"
          NEXT_PUBLIC_API_URL: http://localhost:3000
          SKIP_ENV_VALIDATION: "true"
          NEXTAUTH_URL: https://tec-ecosystem.vercel.app
          NEXTAUTH_SECRET: dummy_secret_for_build_only

      # 8ï¸âƒ£ Check build output
      - name: ðŸ“Š Verify Build Output
        run: |
          echo "ðŸ” Checking build output..."
          if [ ! -d ".next" ]; then
            echo "âŒ .next directory not found!"
            exit 1
          fi
          echo "âœ… .next directory exists"
          
          # Check for critical files
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âŒ BUILD_ID not found!"
            exit 1
          fi
          echo "âœ… BUILD_ID found: $(cat .next/BUILD_ID)"
          
          # Display build info
          echo "ðŸ“Š Build Statistics:"
          du -sh .next/
          echo "ðŸ“„ Pages built: $(find .next -name '*.html' | wc -l)"
          echo "ðŸ“¦ JS chunks: $(find .next -name '*.js' | wc -l)"

      # 9ï¸âƒ£ Verify environment variables template
      - name: ðŸ” Check Environment Variables Template
        run: |
          echo "ðŸ” Checking .env.example..."
          if [ ! -f ".env.example" ]; then
            echo "âš ï¸ Warning: .env.example not found!"
          else
            echo "âœ… .env.example found"
            echo "ðŸ“‹ Required Environment Variables:"
            grep "^[A-Z]" .env.example | grep -v "^#" | cut -d= -f1 | sort | uniq
          fi

      # ðŸ”Ÿ Test vercel-ignore script logic
      - name: ðŸ§ª Test Branch Filter Logic
        run: |
          echo "ðŸ§ª Testing vercel-ignore.sh logic..."
          
          # Test main branch (should build)
          export VERCEL_GIT_COMMIT_REF="main"
          if bash vercel-ignore.sh; then
            echo "âŒ Main branch returned exit 0 (should be exit 1 to build)"
            exit 1
          else
            echo "âœ… Main branch will trigger build (exit 1)"
          fi
          
          # Test staging branch (should build)
          export VERCEL_GIT_COMMIT_REF="staging"
          if bash vercel-ignore.sh; then
            echo "âŒ Staging branch returned exit 0 (should be exit 1 to build)"
            exit 1
          else
            echo "âœ… Staging branch will trigger build (exit 1)"
          fi
          
          # Test other branch (should skip)
          export VERCEL_GIT_COMMIT_REF="feature/test"
          if bash vercel-ignore.sh; then
            echo "âœ… Feature branch will skip build (exit 0)"
          else
            echo "âŒ Feature branch returned exit 1 (should be exit 0 to skip)"
            exit 1
          fi

      # 1ï¸âƒ£1ï¸âƒ£ Check Next.js configuration
      - name: âš™ï¸ Verify Next.js Configuration
        run: |
          echo "ðŸ” Checking next.config.js..."
          if [ ! -f "next.config.js" ]; then
            echo "âŒ next.config.js not found!"
            exit 1
          fi
          echo "âœ… next.config.js found"
          
          # Display configuration
          echo "ðŸ“‹ Next.js Configuration:"
          cat next.config.js

      # 1ï¸âƒ£2ï¸âƒ£ Verify deployment documentation
      - name: ðŸ“š Check Deployment Documentation
        run: |
          echo "ðŸ” Checking deployment documentation..."
          
          docs_found=0
          
          if [ -f "VERCEL_DEPLOYMENT_CHECKS.md" ]; then
            echo "âœ… VERCEL_DEPLOYMENT_CHECKS.md found"
            docs_found=$((docs_found + 1))
          fi
          
          if [ -f "DEPLOY_INSTRUCTIONS.md" ]; then
            echo "âœ… DEPLOY_INSTRUCTIONS.md found"
            docs_found=$((docs_found + 1))
          fi
          
          if [ -f "DEPLOY_NOW.md" ]; then
            echo "âœ… DEPLOY_NOW.md found"
            docs_found=$((docs_found + 1))
          fi
          
          if [ $docs_found -eq 0 ]; then
            echo "âš ï¸ Warning: No deployment documentation found"
          else
            echo "âœ… Found $docs_found deployment documentation file(s)"
          fi

      # 1ï¸âƒ£3ï¸âƒ£ Final summary
      - name: âœ… Deployment Ready Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ‰ Vercel Deployment Check Passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… vercel.json is valid and configured"
          echo "âœ… Build completes successfully"
          echo "âœ… Branch filtering logic works correctly"
          echo "âœ… All required files are present"
          echo ""
          echo "ðŸš€ Ready for Vercel deployment!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # 1ï¸âƒ£4ï¸âƒ£ Create deployment status
      - name: ðŸ“ Update Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=Vercel deployment checks passed âœ…" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=Vercel deployment checks failed âŒ" >> $GITHUB_OUTPUT
          fi

name: TEC Sovereign AI Factory & Build 2026

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: write
  checks: write
  actions: read

jobs:
  build-and-sovereign:
    runs-on: ubuntu-latest
    
    env:  
      NODE_ENV: production  

      # üîó App / Sandbox / Base URLs  
      NEXT_PUBLIC_BASE_URL: https://tec-ecosystem.vercel.app  
      DATABASE_URL: postgresql://dummy:user@dummy:5432/dummy?schema=public  
      NEXT_PUBLIC_PI_APP_ID: dummy_app_id  
      NEXT_PUBLIC_PI_SANDBOX: true  
      NEXT_PUBLIC_API_URL: http://localhost:3000  
      SKIP_ENV_VALIDATION: true  

      # üîê AI Models & API Keys  
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}  

      # üèõÔ∏è Paid Core Models  
      GPT_MODEL: ${{ secrets.GPT_MODEL }}  
      CLAUDE_MODEL: ${{ secrets.CLAUDE_MODEL }}  
      GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}  
      CODEX_MODEL: ${{ secrets.CODEX_MODEL }}  

      # üõ°Ô∏è Free / Reserve Models  
      DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}  
      LLAMA_MODEL: ${{ secrets.LLAMA_MODEL }}  
      QWEN_MODEL: ${{ secrets.QWEN_MODEL }}  
      HERMES_MODEL: ${{ secrets.HERMES_MODEL }}  
      GPT_OSS_FREE: ${{ secrets.GPT_OSS_FREE }}  
      GEMINI_FLASH_FREE: ${{ secrets.GEMINI_FLASH_FREE }}  
      O4_ENGINEER_MODEL: ${{ secrets.O4_ENGINEER_MODEL }}  
      DEVSTRAL_MODEL: ${{ secrets.DEVSTRAL_MODEL }}  

    steps:  
      # 1Ô∏è‚É£ Checkout repository  
      - name: üì• Checkout code  
        uses: actions/checkout@v4  

      # 2Ô∏è‚É£ Setup Node.js  
      - name: üü¢ Setup Node.js  
        uses: actions/setup-node@v4  
        with:  
          node-version: "20"  
          cache: "npm"  

      # 3Ô∏è‚É£ Install dependencies  
      - name: üìö Install dependencies  
        run: npm ci  

      # 4Ô∏è‚É£ Generate Prisma Client  
      - name: üîß Generate Prisma Client  
        run: npx prisma generate  

      # 5Ô∏è‚É£ Build Next.js Application  
      - name: üèóÔ∏è Build Next.js Application  
        run: npm run build  

      # 5.5Ô∏è‚É£ Run Protection Layer Tests  
      - name: üß™ Run Protection Layer Tests  
        run: |  
          npm test -- tests/unit/api-guard.test.js  
          npm test -- tests/unit/selectModel.test.js  
        continue-on-error: false  

      # 6Ô∏è‚É£ Run AI Sovereign Factory (Self-Healing & Agents)  
      - name: ü§ñ Run AI Self-Healing System (Sovereign Factory)  
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'  
        id: ai_process  
        run: node index.js  
        continue-on-error: true  

      # 7Ô∏è‚É£ AI Failure Summary  
      - name: ‚ö†Ô∏è AI Failure Summary  
        if: steps.ai_process.outcome == 'failure'  
        run: |  
          echo "### ‚ùå ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ∞ŸÉŸä ŸÅŸä ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÉŸàÿØ ŸÖÿ≥ÿ™ŸÇÿ±" >> $GITHUB_STEP_SUMMARY  
          echo "ÿ™ŸÖ ÿ•ÿ¨ÿ±ÿßÿ° ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿ™ÿµÿ≠Ÿäÿ≠ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸàŸÑŸÖ ÿ™ŸÜÿ¨ÿ≠." >> $GITHUB_STEP_SUMMARY  
          echo "Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÄ Logs ŸäÿØŸàŸäÿßŸã." >> $GITHUB_STEP_SUMMARY  
          exit 1  

      # 8Ô∏è‚É£ Upload Build + Ledger + Artifacts  
      - name: üì¶ Upload Build & Ledger Artifacts  
        uses: actions/upload-artifact@v4  
        with:  
          name: build-and-sovereign-output  
          path: |  
            .next/  
            public/  
            ledger_full_log.json  
            build.log  
          retention-days: 7  

      # 9Ô∏è‚É£ Success Notification  
      - name: ‚úÖ Build & Factory Success  
        if: success()  
        run: echo "‚úÖ Build + AI Factory completed successfully!"

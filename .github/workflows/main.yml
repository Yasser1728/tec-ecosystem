name: TEC Sovereign AI Factory & Build 2026

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read   # Changed from write to read (principle of least privilege)
  checks: write    # Required for test results
  actions: read    # Required for artifacts

jobs:
  build-and-sovereign:
    runs-on: ubuntu-latest

    env:
      NODE_ENV: production

      # ðŸ”— App / Sandbox / Base URLs
      NEXT_PUBLIC_BASE_URL: https://tec-ecosystem.vercel.app
      DATABASE_URL: postgresql://dummy:user@dummy:5432/dummy?schema=public
      NEXT_PUBLIC_PI_APP_ID: dummy_app_id
      NEXT_PUBLIC_PI_SANDBOX: true
      NEXT_PUBLIC_API_URL: http://localhost:3000
      SKIP_ENV_VALIDATION: true

      # ðŸ” AI Models & API Keys
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      # ðŸ›ï¸ Paid Core Models
      GPT_MODEL: ${{ secrets.GPT_MODEL }}
      CLAUDE_MODEL: ${{ secrets.CLAUDE_MODEL }}
      GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
      CODEX_MODEL: ${{ secrets.CODEX_MODEL }}

      # ðŸ›¡ï¸ Free / Reserve Models
      DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
      LLAMA_MODEL: ${{ secrets.LLAMA_MODEL }}
      QWEN_MODEL: ${{ secrets.QWEN_MODEL }}
      HERMES_MODEL: ${{ secrets.HERMES_MODEL }}
      GPT_OSS_FREE: ${{ secrets.GPT_OSS_FREE }}
      GEMINI_FLASH_FREE: ${{ secrets.GEMINI_FLASH_FREE }}
      O4_ENGINEER_MODEL: ${{ secrets.O4_ENGINEER_MODEL }}
      DEVSTRAL_MODEL: ${{ secrets.DEVSTRAL_MODEL }}

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3ï¸âƒ£ Install dependencies
      # Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù†Ø¯Ø³ AI: Ù„Ùˆ Ø§Ù„Ù€ npm ci Ø¨ÙŠÙØ´Ù„ØŒ Ø´ØºÙ„ npm install Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ§Ø±ÙØ¹ Ø§Ù„Ù€ lock file Ø§Ù„Ø¬Ø¯ÙŠØ¯
      - name: ðŸ“š Install dependencies
        env:
          NPM_CONFIG_PRODUCTION: "false"
        run: npm ci

      # ðŸ›¡ï¸ 4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø­ÙˆÙƒÙ…Ø© (AI Engineering Check)
      # ØªØ¶Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ø£Ù† Ø§Ù„Ù€ AI ÙŠÙ„ØªØ²Ù… Ø¨Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ÙˆØ§Ù„Ù€ Ledger
      - name: ðŸ›ï¸ Run Sovereign Governance Tests
        run: npm run test:governance
        # ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¶Ø§ÙØ© Ù„Ù„Ù€ scripts Ø¨Ø¹Ø¯ØŒ Ø§Ø³ØªØ®Ø¯Ù…: npx jest tests/unit/governance.test.js

      # 5ï¸âƒ£ Generate Prisma Client
      - name: ðŸ”§ Generate Prisma Client
        run: npx prisma generate

      # 6ï¸âƒ£ Build Next.js Application
      - name: ðŸ—ï¸ Build Next.js Application
        run: npm run build

      # 7ï¸âƒ£ Run AI Sovereign Factory (Self-Healing & Agents)
      # Note: continue-on-error is intentional to allow failure reporting
      # without blocking the pipeline. The next step will handle failure.
      - name: ðŸ¤– Run AI Self-Healing System (Sovereign Factory)
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        id: ai_process
        run: node index.js
        continue-on-error: true

      # 8ï¸âƒ£ AI Failure Summary
      - name: âš ï¸ AI Failure Summary
        if: steps.ai_process.outcome == 'failure'
        run: |
          echo "### âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ÙƒÙˆØ¯ Ù…Ø³ØªÙ‚Ø±" >> $GITHUB_STEP_SUMMARY  
          echo "ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØµØ­ÙŠØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆÙ„Ù… ØªÙ†Ø¬Ø­." >> $GITHUB_STEP_SUMMARY  
          echo "ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù€ Logs ÙŠØ¯ÙˆÙŠØ§Ù‹." >> $GITHUB_STEP_SUMMARY  
          exit 1

      # 9ï¸âƒ£ Upload Build + Ledger + Artifacts
      - name: ðŸ“¦ Upload Build & Ledger Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-and-sovereign-output
          path: |
            .next/  
            public/  
            agents/sovereign-agent/ledger.json
            build.log
          retention-days: 7

      # ðŸ”Ÿ Success Notification
      - name: âœ… Build & Factory Success
        if: success()
        run: echo "âœ… Build + AI Factory completed successfully!"

  vercel-deploy:
    runs-on: ubuntu-latest
    needs: build-and-sovereign
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    permissions:
      contents: read
      deployments: write
      statuses: write
      pull-requests: write
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && '--prod' || '' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-comment: false
          working-directory: ./

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "### ðŸš€ Vercel Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.vercel-deploy.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'Production' || 'Preview' }}" >> $GITHUB_STEP_SUMMARY

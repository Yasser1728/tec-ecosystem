name: Deployment Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write
  deployments: write

jobs:
  # Wait for all checks to complete
  wait-for-checks:
    name: ‚è≥ Wait for All Checks
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚è≥ Wait for status checks
        uses: lewagon/wait-on-check-action@v1.3.4
        continue-on-error: true
        with:
          ref: ${{ github.ref }}
          check-regexp: "(Build|Lint|Tests|Security).*"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success,skipped,neutral

  # Pre-deployment validation
  pre-deployment:
    name: üîç Pre-Deployment Validation
    runs-on: ubuntu-latest
    needs: [wait-for-checks]

    env:
      DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy?schema=public
      NEXTAUTH_URL: https://tec-ecosystem.vercel.app
      NEXTAUTH_SECRET: dummy-secret-for-validation
      PI_API_KEY: dummy-key
      SKIP_ENV_VALIDATION: true

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üìö Install dependencies
        run: npm ci

      - name: ‚úÖ Validate package.json
        run: |
          echo "Validating package.json..."
          node -e "require('./package.json')"

      - name: ‚úÖ Validate environment variables
        run: |
          echo "Checking required environment variables..."
          # Add your required env vars here
          required_vars=("NEXTAUTH_URL" "PI_API_KEY" "DATABASE_URL")
          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "‚ö†Ô∏è Warning: $var is not set (will be set in Vercel)"
            fi
          done

      - name: ‚úÖ Check for TODO/FIXME
        run: |
          echo "Checking for critical TODOs..."
          if grep -r "TODO.*CRITICAL\|FIXME.*CRITICAL" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" .; then
            echo "‚ö†Ô∏è Critical TODOs found!"
            exit 1
          fi
        continue-on-error: true

      - name: ‚úÖ Validate Prisma schema
        run: npx prisma validate || echo "Prisma validation skipped - DATABASE_URL will be set in Vercel"
        continue-on-error: true

      - name: ‚úÖ Check bundle size
        run: |
          npm run build
          echo "Checking bundle size..."
          # Add bundle size checks here

  # Deployment readiness check
  deployment-ready:
    name: ‚úÖ Deployment Ready
    runs-on: ubuntu-latest
    needs: [pre-deployment]
    if: always()

    steps:
      - name: ‚úÖ Deployment Checks Complete
        run: |
          echo "‚úÖ Deployment checks completed!"
          echo "üöÄ Ready for deployment"

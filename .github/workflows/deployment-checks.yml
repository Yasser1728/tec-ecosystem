name: Deployment Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write
  deployments: write

jobs:
  # Wait for all checks to complete
  wait-for-checks:
    name: â³ Wait for All Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â³ Wait for status checks
        uses: lewagon/wait-on-check-action@v1.3.4
        continue-on-error: true
        with:
          ref: ${{ github.ref }}
          check-regexp: '(Build|Lint|Tests|Security).*'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success,skipped,neutral

  # Pre-deployment validation
  pre-deployment:
    name: ğŸ” Pre-Deployment Validation
    runs-on: ubuntu-latest
    needs: [wait-for-checks]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: âœ… Validate package.json
        run: |
          echo "Validating package.json..."
          node -e "require('./package.json')"

      - name: âœ… Validate environment variables
        run: |
          echo "Checking required environment variables..."
          # Add your required env vars here
          required_vars=("NEXTAUTH_URL" "PI_API_KEY" "DATABASE_URL")
          for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "âš ï¸ Warning: $var is not set (will be set in Vercel)"
            fi
          done

      - name: âœ… Check for TODO/FIXME
        run: |
          echo "Checking for critical TODOs..."
          if grep -r "TODO.*CRITICAL\|FIXME.*CRITICAL" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" .; then
            echo "âš ï¸ Critical TODOs found!"
            exit 1
          fi
        continue-on-error: true

      - name: âœ… Validate Prisma schema
        run: npx prisma validate

      - name: âœ… Check bundle size
        run: |
          npm run build
          echo "Checking bundle size..."
          # Add bundle size checks here

  # Deployment readiness check
  deployment-ready:
    name: âœ… Deployment Ready
    runs-on: ubuntu-latest
    needs: [pre-deployment]
    if: always()

    steps:
      - name: âœ… Deployment Checks Complete
        run: |
          echo "âœ… Deployment checks completed!"
          echo "ğŸš€ Ready for deployment"

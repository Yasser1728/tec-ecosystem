name: "Security Analysis v1.0.0"

on:
push:
branches: ["main", "develop"]
pull_request:
branches: ["main", "develop"]
schedule:
- cron: "0 2 * * *"
workflow_dispatch:

permissions:
contents: read
security-events: write
actions: read
pull-requests: write
issues: write

env:
SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN || '' }}
AI_SECURITY_API: ${{ secrets.AI_SECURITY_API || '' }}

jobs:

------------------------------

ðŸ” SECRET SCANNING

------------------------------

secret-scanning:
name: "ðŸ” Secret Scanning (TruffleHog)"
runs-on: ubuntu-latest
outputs:
has_secrets: ${{ steps.trufflehog.outcome == 'failure' }}

steps:  
  - uses: actions/checkout@v4  
    with:  
      fetch-depth: 0  

  - name: Run TruffleHog  
    id: trufflehog  
    uses: trufflesecurity/trufflehog@main  
    with:  
      path: ./  
      extra_args: --only-verified --fail  
    continue-on-error: true  

  - name: Report secrets detected  
    if: steps.trufflehog.outcome == 'failure'  
    run: |  
      echo "::error::ðŸš¨ Verified secrets detected!"  
      echo "### ðŸš¨ Secrets Found" >> $GITHUB_STEP_SUMMARY  
      echo "**Action Required:** Follow [Secret Rotation Runbook](./docs/security/SECRET_ROTATION.md)" >> $GITHUB_STEP_SUMMARY  
      echo "Rotate credentials immediately." >> $GITHUB_STEP_SUMMARY

------------------------------

ðŸ”¬ CODEQL

------------------------------

codeql-analysis:
name: "ðŸ”¬ CodeQL Analysis"
runs-on: ubuntu-latest

steps:  
  - uses: actions/checkout@v4  

  - uses: github/codeql-action/init@v3  
    with:  
      languages: javascript  
      queries: security-extended  

  - uses: github/codeql-action/autobuild@v3  

  - uses: github/codeql-action/analyze@v3  
    with:  
      category: "/language:javascript"

------------------------------

ðŸ“¦ DEPENDENCY REVIEW (PR Only)

------------------------------

dependency-review:
name: "ðŸ“¦ Dependency Review"
if: github.event_name == 'pull_request'
runs-on: ubuntu-latest
outputs:
has_critical: ${{ steps.review.outcome == 'failure' }}

steps:  
  - uses: actions/checkout@v4  

  - id: review  
    uses: actions/dependency-review-action@v4  
    with:  
      fail-on-severity: critical  
      deny-licenses: GPL-3.0, AGPL-3.0  
    continue-on-error: true  

  - name: Report critical dependencies  
    if: steps.review.outcome == 'failure'  
    run: |  
      echo "::error::ðŸ“¦ Critical vulnerabilities or license violations detected"  
      echo "### âš ï¸ Dependency Issues" >> $GITHUB_STEP_SUMMARY  
      echo "Review the dependency-review output for details." >> $GITHUB_STEP_SUMMARY

------------------------------

ðŸ›¡ï¸ SAST â€“ SEMGREP (Soft Signal)

------------------------------

sast-semgrep:
name: "ðŸ›¡ï¸ SAST (Semgrep)"
runs-on: ubuntu-latest

steps:  
  - uses: actions/checkout@v4  

  - name: Run Semgrep  
    uses: returntocorp/semgrep-action@v1  
    with:  
      config: "p/security-audit p/secrets p/owasp-top-ten p/javascript"  
      generateSarif: true  
    continue-on-error: true  

  - uses: github/codeql-action/upload-sarif@v3  
    if: always()  
    with:  
      sarif_file: semgrep.sarif  
      category: semgrep

------------------------------

ðŸ“‹ SECURITY SUMMARY

------------------------------

security-summary:
name: "ðŸ“‹ Security Summary"
runs-on: ubuntu-latest
needs:
- secret-scanning
- codeql-analysis
- dependency-review
- sast-semgrep
if: always()

steps:  
  - name: Generate summary  
    run: |  
      echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY  
      echo "" >> $GITHUB_STEP_SUMMARY  
      echo "| Tool | Status | Notes |" >> $GITHUB_STEP_SUMMARY  
      echo "|------|--------|-------|" >> $GITHUB_STEP_SUMMARY  
      echo "| ðŸ” TruffleHog | ${{ needs.secret-scanning.result }} | Secrets check |" >> $GITHUB_STEP_SUMMARY  
      echo "| ðŸ”¬ CodeQL | ${{ needs.codeql-analysis.result }} | Static analysis |" >> $GITHUB_STEP_SUMMARY  
      echo "| ðŸ“¦ Dependency Review | ${{ needs.dependency-review.result || 'skipped' }} | PR dependency check |" >> $GITHUB_STEP_SUMMARY  
      echo "| ðŸ›¡ï¸ Semgrep | ${{ needs.sast-semgrep.result }} | Pattern scan |" >> $GITHUB_STEP_SUMMARY  
      echo "" >> $GITHUB_STEP_SUMMARY  
      echo "ðŸ“… **Scan completed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY  

  - name: Send results to AI Security Agent  
    if: env.AI_SECURITY_API != ''  
    continue-on-error: true  
    run: |  
      PAYLOAD=$(cat <<EOF  
      {  
        "workflow": "security-analysis",  
        "version": "1.0.0",  
        "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",  
        "event": "${{ github.event_name }}",  
        "ref": "${{ github.ref }}",  
        "sha": "${{ github.sha }}",  
        "results": {  
          "trufflehog": {  
            "status": "${{ needs.secret-scanning.result }}",  
            "has_findings": ${{ needs.secret-scanning.outputs.has_secrets }}  
          },  
          "codeql": {  
            "status": "${{ needs.codeql-analysis.result }}"  
          },  
          "dependency_review": {  
            "status": "${{ needs.dependency-review.result || 'skipped' }}",  
            "has_critical": ${{ needs.dependency-review.outputs.has_critical || false }}  
          },  
          "semgrep": {  
            "status": "${{ needs.sast-semgrep.result }}"  
          }  
        },  
        "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"  
      }  
      EOF  
      )  
        
      HTTP_CODE=$(curl -s -o /tmp/ai_response.json -w "%{http_code}" \  
        -X POST "$AI_SECURITY_API" \  
        -H "Content-Type: application/json" \  
        -H "X-GitHub-Event: ${{ github.event_name }}" \  
        -H "X-GitHub-Repository: ${{ github.repository }}" \  
        --retry 3 \  
        --retry-delay 2 \  
        --max-time 10 \  
        -d "$PAYLOAD")  
        
      if [ "$HTTP_CODE" -eq 200 ]; then  
        echo "âœ… AI Security Agent notified successfully"  
        cat /tmp/ai_response.json  
      else  
        echo "âš ï¸ AI Security Agent returned HTTP $HTTP_CODE"  
        cat /tmp/ai_response.json || true  
      fi

------------------------------

ðŸš« MERGE BLOCKER

------------------------------

block-merge:
name: "ðŸš« Block Merge on Critical Issues"
runs-on: ubuntu-latest
needs:
- secret-scanning
- dependency-review
if: |
github.event_name == 'pull_request' &&
(needs.secret-scanning.outputs.has_secrets == 'true' ||
needs.dependency-review.outputs.has_critical == 'true')

steps:  
  - name: Block merge  
    run: |  
      echo "::error::ðŸš« MERGE BLOCKED â€“ Critical security findings"  
      echo ""  
      echo "Blocking reasons:"  
      if [ "${{ needs.secret-scanning.outputs.has_secrets }}" == "true" ]; then  
        echo "  âŒ Verified secrets detected in repository"  
      fi  
      if [ "${{ needs.dependency-review.outputs.has_critical }}" == "true" ]; then  
        echo "  âŒ Critical dependency vulnerabilities or license violations"  
      fi  
      echo ""  
      echo "ðŸ“– See: docs/security/INCIDENT_RESPONSE.md"  
      exit 1

------------------------------

ðŸ“§ NOTIFY (Scheduled Only)

------------------------------

notify-scheduled-failures:
name: "ðŸ“§ Notify Security Team"
runs-on: ubuntu-latest
needs:
- secret-scanning
- codeql-analysis
if: |
github.event_name == 'schedule' &&
(needs.secret-scanning.result == 'failure' || needs.codeql-analysis.result == 'failure')

steps:  
  - uses: actions/github-script@v7  
    with:  
      script: |  
        const title = 'ðŸš¨ Scheduled Security Scan Failed';  
        const body = `  
        ## Security Alert - Scheduled Scan  
          
        **Scan Time:** ${new Date().toISOString()}  
        **Version:** v1.0.0  
          
        ### Results  
        - **TruffleHog:** ${{ needs.secret-scanning.result }}  
        - **CodeQL:** ${{ needs.codeql-analysis.result }}  
          
        ### Action Required  
        Review findings in [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})  
          
        **Follow:** [Incident Response Playbook](./docs/security/INCIDENT_RESPONSE.md)  
          
        cc: @security-team  
        `;  
          
        await github.rest.issues.create({  
          owner: context.repo.owner,  
          repo: context.repo.repo,  
          title: title,  
          body: body,  
          labels: ['security', 'urgent', 'automated']  
        });

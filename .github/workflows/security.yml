name: "Security Analysis v2.0.0"

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

# Global permissions - minimal by default, escalated per job
permissions:
  contents: read

# Concurrency control - cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN || '' }}
  AI_SECURITY_API: ${{ secrets.AI_SECURITY_API || '' }}
  # Snyk token - optional for Snyk integration
  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN || '' }}

jobs:
  # ------------------------------
  # ðŸ” SECRET SCANNING
  # ------------------------------
  secret-scanning:
    name: "ðŸ” Secret Scanning (TruffleHog)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    outputs:
      has_secrets: ${{ steps.trufflehog.outcome == 'failure' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Note: continue-on-error is intentional to allow reporting secrets
      # without blocking the build. The outcome is checked in the next step.
      - name: Run TruffleHog
        id: trufflehog
        uses: trufflesecurity/trufflehog@v3.92.5
        with:
          path: ./
          extra_args: --only-verified --fail
        continue-on-error: true

      - name: Report secrets detected
        if: steps.trufflehog.outcome == 'failure'
        run: |
          echo "::error::ðŸš¨ Verified secrets detected!"
          echo "### ðŸš¨ Secrets Found" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** Follow [Secret Rotation Runbook](./docs/security/SECRET_ROTATION.md)" >> $GITHUB_STEP_SUMMARY
          echo "Rotate credentials immediately." >> $GITHUB_STEP_SUMMARY

  # ------------------------------
  # ðŸ”¬ CODEQL ANALYSIS
  # ------------------------------
  codeql-analysis:
    name: "ðŸ”¬ CodeQL Analysis"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript"
          upload: true

  # ------------------------------
  # ðŸ“¦ DEPENDENCY REVIEW (PR Only)
  # ------------------------------
  dependency-review:
    name: "ðŸ“¦ Dependency Review"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    outputs:
      has_critical: ${{ steps.review.outcome == 'failure' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Dependency Review
        id: review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: critical
          fail-on-scopes: runtime
          deny-licenses: GPL-3.0, AGPL-3.0, SSPL-1.0
          comment-summary-in-pr: on-failure
          vulnerability-check: true
          license-check: true
        # Note: continue-on-error allows collecting all dependency issues
        # before deciding whether to fail. The outcome is checked below.
        continue-on-error: true

      - name: Report critical dependencies
        if: steps.review.outcome == 'failure'
        run: |
          echo "::error::ðŸ“¦ Critical vulnerabilities or license violations detected"
          echo "### âš ï¸ Dependency Issues" >> $GITHUB_STEP_SUMMARY
          echo "Review the dependency-review output for details." >> $GITHUB_STEP_SUMMARY

  # ------------------------------
  # ðŸ›¡ï¸ SAST â€“ SEMGREP
  # ------------------------------
  sast-semgrep:
    name: "ðŸ›¡ï¸ SAST (Semgrep)"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/security-audit p/secrets p/owasp-top-ten p/javascript p/typescript p/react"
          generateSarif: true
        # Note: continue-on-error allows SARIF upload even if findings exist
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep

  # ------------------------------
  # ðŸ” TRIVY FILESYSTEM SCAN
  # ------------------------------
  trivy-scan:
    name: "ðŸ” Trivy Filesystem Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          ignore-unfixed: true
        # Note: continue-on-error allows vulnerability reporting without blocking
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
          category: trivy

      - name: Generate Trivy report
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "table"
          severity: "CRITICAL,HIGH"
        # Note: continue-on-error allows report generation even with findings
        continue-on-error: true

  # ------------------------------
  # ðŸ SNYK VULNERABILITY SCAN (Optional)
  # ------------------------------
  snyk-scan:
    name: "ðŸ Snyk Vulnerability Scan"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: env.SNYK_TOKEN != ''
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@v1.0.0
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk.sarif --severity-threshold=high
        # Note: continue-on-error allows SARIF upload even with vulnerabilities
        continue-on-error: true

      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: snyk.sarif
          category: snyk

  # ------------------------------
  # ðŸ“¦ SBOM GENERATION
  # ------------------------------
  sbom-generation:
    name: "ðŸ“¦ SBOM Generation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0.21.1
        with:
          format: spdx-json
          output-file: sbom.spdx.json
          upload-artifact: true
          upload-release-assets: false

      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@v0.21.1
        with:
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json
          upload-artifact: true
          upload-release-assets: false

  # ------------------------------
  # ðŸ“‹ SECURITY SUMMARY
  # ------------------------------
  security-summary:
    name: "ðŸ“‹ Security Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    needs:
      [
        secret-scanning,
        codeql-analysis,
        dependency-review,
        sast-semgrep,
        trivy-scan,
        snyk-scan,
        sbom-generation,
      ]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Version:** v2.0.0" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” TruffleHog | ${{ needs.secret-scanning.result }} | Secret scanning |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¬ CodeQL | ${{ needs.codeql-analysis.result }} | Static analysis (JavaScript) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Dependency Review | ${{ needs.dependency-review.result || 'skipped' }} | PR dependency check |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Semgrep | ${{ needs.sast-semgrep.result }} | SAST pattern scanning |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Trivy | ${{ needs.trivy-scan.result }} | Filesystem vulnerability scan |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Snyk | ${{ needs.snyk-scan.result || 'skipped' }} | Advanced vulnerability scan |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ SBOM | ${{ needs.sbom-generation.result }} | Software Bill of Materials |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**View detailed results:** [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Send results to AI Security Agent
        if: env.AI_SECURITY_API != ''
        # Note: continue-on-error makes AI agent reporting optional
        continue-on-error: true
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "workflow": "security-analysis",
            "version": "2.0.0",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "event": "${{ github.event_name }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "results": {
              "trufflehog": {
                "status": "${{ needs.secret-scanning.result }}",
                "has_findings": "${{ needs.secret-scanning.outputs.has_secrets }}"
              },
              "codeql": {
                "status": "${{ needs.codeql-analysis.result }}"
              },
              "dependency_review": {
                "status": "${{ needs.dependency-review.result || 'skipped' }}",
                "has_critical": "${{ needs.dependency-review.outputs.has_critical }}"
              },
              "semgrep": {
                "status": "${{ needs.sast-semgrep.result }}"
              },
              "trivy": {
                "status": "${{ needs.trivy-scan.result }}"
              },
              "snyk": {
                "status": "${{ needs.snyk-scan.result || 'skipped' }}"
              },
              "sbom": {
                "status": "${{ needs.sbom-generation.result }}"
              }
            },
            "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          )
          curl -s -X POST "$AI_SECURITY_API" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" || true

  # ------------------------------
  # ðŸš« MERGE BLOCKER
  # ------------------------------
  block-merge:
    name: "ðŸš« Block Merge on Critical Issues"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    needs: [secret-scanning, dependency-review]
    if: |
      github.event_name == 'pull_request' &&
      (needs.secret-scanning.outputs.has_secrets == 'true' || needs.dependency-review.outputs.has_critical == 'true')
    steps:
      - name: Block merge
        run: |
          echo "::error::ðŸš« MERGE BLOCKED â€“ Critical security findings"
          echo "## ðŸš« Merge Blocked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.secret-scanning.outputs.has_secrets }}" == "true" ]; then
            echo "- âŒ **Secrets detected** - Rotate credentials immediately" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.dependency-review.outputs.has_critical }}" == "true" ]; then
            echo "- âŒ **Critical dependency vulnerabilities** - Update or remove vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** Fix all critical issues before merging." >> $GITHUB_STEP_SUMMARY
          exit 1

  # ------------------------------
  # ðŸ“§ NOTIFY (Scheduled Only)
  # ------------------------------
  notify-scheduled-failures:
    name: "ðŸ“§ Notify Security Team"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      issues: write
    needs: [secret-scanning, codeql-analysis, trivy-scan]
    if: |
      github.event_name == 'schedule' &&
      (needs.secret-scanning.result == 'failure' || needs.codeql-analysis.result == 'failure' || needs.trivy-scan.result == 'failure')
    steps:
      - name: Create security alert issue
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ðŸš¨ Scheduled Security Scan Failed';
            const body = `
            ## Security Alert - Scheduled Scan

            **Scan Time:** ${new Date().toISOString()}
            **Workflow Version:** v2.0.0
            **Branch:** ${{ github.ref }}
            **Commit:** ${{ github.sha }}

            ### Results
            - **TruffleHog:** ${{ needs.secret-scanning.result }}
            - **CodeQL:** ${{ needs.codeql-analysis.result }}
            - **Trivy:** ${{ needs.trivy-scan.result }}

            ### Action Required
            1. Review findings in [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. **Follow:** [Incident Response Playbook](./docs/security/INCIDENT_RESPONSE.md)
            3. Address all critical and high severity issues
            4. Document remediation steps

            ### Resources
            - [Security Policy](./SECURITY.md)
            - [Secret Rotation Runbook](./docs/security/SECRET_ROTATION.md)
            - [Vulnerability Management](./docs/security/VULNERABILITY_MANAGEMENT.md)

            cc: @tec-ecosystem/security-team

            ---
            *This issue was automatically created by the Security Analysis workflow*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['security', 'urgent', 'automated', 'scheduled-scan']
            });

name: "ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† Ø¹Ø¨Ø± ÙƒÙˆØ¯Ø§Ø³ÙŠ - Codacy Security Scan"

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write  # Ø¯ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù„ÙŠ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ© Ø¹Ø´Ø§Ù† ÙŠØ±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  actions: read

jobs:
  codacy-security-scan:
    name: "Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ÙØ­Øµ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù†"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ"
        uses: actions/checkout@v4

      - name: "ğŸ›¡ï¸ ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ ÙØ­Øµ ÙƒÙˆØ¯Ø§Ø³ÙŠ"
        uses: codacy/codacy-analysis-cli-action@v4
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          verbose: true
          output: results.sarif
          format: sarif
          directory: "/github/workspace"

      - name: "ğŸ” ÙØ­Øµ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ù…Ø§Ù†"
        id: check-sarif
        run: |
          if [ -f results.sarif ]; then
            echo "âœ… Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…ÙˆØ¬ÙˆØ¯"
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… wc -c Ù„Ù„ØªÙˆØ§ÙÙ‚ Ø¹Ø¨Ø± Ø§Ù„Ù…Ù†ØµØ§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
            SARIF_SIZE=$(wc -c < results.sarif)
            echo "ğŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $SARIF_SIZE Ø¨Ø§ÙŠØª"
            # Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù…Ù„Ù SARIF ØµØ§Ù„Ø­ Ù‡Ùˆ 100 Ø¨Ø§ÙŠØª (Ø¨Ù†ÙŠØ© JSON Ø£Ø³Ø§Ø³ÙŠØ©)
            if [ "$SARIF_SIZE" -gt 100 ]; then
              echo "has_results=true" >> $GITHUB_OUTPUT
              echo "âœ… Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬"
            else
              echo "has_results=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ÙƒØ§ÙÙŠØ©"
            fi
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
            echo "âŒ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          fi

      - name: "ğŸ“Š Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø¥Ù„Ù‰ Ø¬ÙŠØª Ù‡Ø§Ø¨"
        # Ù†Ø±ÙØ¹ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ØµØ§Ù„Ø­Ø©
        if: steps.check-sarif.outputs.has_results == 'true'
        uses: github/codeql-action/upload-sarif@v3
        # Ù†ØªØ§Ø¨Ø¹ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ø®Ø±Ù‰
        continue-on-error: true
        with:
          sarif_file: results.sarif
          token: ${{ github.token }}

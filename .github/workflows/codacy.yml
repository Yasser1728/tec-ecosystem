name: "ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† Ø¹Ø¨Ø± ÙƒÙˆØ¯Ø§Ø³ÙŠ - Codacy Security Scan"

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  # Scheduled weekly security scan
  schedule:
    - cron: "0 6 * * 0" # Every Sunday at 6:00 AM UTC
  workflow_dispatch:

# Prevent duplicate runs for the same PR/branch
concurrency:
  group: codacy-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write # Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ© Ø±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ù…Ù†ÙŠØ©
  actions: read
  pull-requests: read

jobs:
  codacy-security-scan:
    name: "Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ÙØ­Øµ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ù„Ø£Ù…Ø§Ù†"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "ðŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for better analysis

      # Cache for faster analysis
      - name: "ðŸ’¾ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª"
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/codacy
            /tmp/codacy
          key: codacy-cache-${{ runner.os }}-${{ hashFiles('**/*.js', '**/*.ts', '**/*.jsx', '**/*.tsx') }}
          restore-keys: |
            codacy-cache-${{ runner.os }}-

      - name: "ðŸ›¡ï¸ ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ ÙØ­Øµ ÙƒÙˆØ¯Ø§Ø³ÙŠ"
        uses: codacy/codacy-analysis-cli-action@v4
        # Continue even if Codacy upload fails (e.g., if Repository Analysis is disabled)
        continue-on-error: true
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          verbose: true
          output: results.sarif
          format: sarif
          directory: "/github/workspace"
          # Skip upload to Codacy API - results are uploaded to GitHub via SARIF
          upload: false

      - name: "ðŸ” ÙØ­Øµ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£Ù…Ø§Ù†"
        id: check-sarif
        run: |
          MIN_SARIF_SIZE=100  # Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù…Ù„Ù SARIF ØµØ§Ù„Ø­
          echo "## ðŸ“Š ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f results.sarif ]; then
            echo "âœ… Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…ÙˆØ¬ÙˆØ¯" >> $GITHUB_STEP_SUMMARY
            SARIF_SIZE=$(wc -c < results.sarif || echo "0")
            echo "ðŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $SARIF_SIZE Ø¨Ø§ÙŠØª" >> $GITHUB_STEP_SUMMARY
            
            if [ "$SARIF_SIZE" -gt "$MIN_SARIF_SIZE" ]; then
              echo "has_results=true" >> $GITHUB_OUTPUT
              echo "âœ… Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØ­Ù„ÙŠÙ„" >> $GITHUB_STEP_SUMMARY
              
              # Count issues if jq is available
              if command -v jq &> /dev/null; then
                ISSUE_COUNT=$(jq '.runs[0].results | length' results.sarif 2>/dev/null || echo "N/A")
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "ðŸ”Ž Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©: $ISSUE_COUNT" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "has_results=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ÙƒØ§ÙÙŠØ©" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
            echo "âŒ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "ðŸ“Š Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø¥Ù„Ù‰ Ø¬ÙŠØª Ù‡Ø§Ø¨"
        if: steps.check-sarif.outputs.has_results == 'true'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: results.sarif
          token: ${{ github.token }}
          category: codacy-security

      - name: "ðŸ’¾ Ø­ÙØ¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙƒÙ…Ø±ÙÙ‚"
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: codacy-security-report-${{ github.run_number }}
          path: |
            results.sarif
          retention-days: 30
          if-no-files-found: ignore

      - name: "âœ… Ù…Ù„Ø®Øµ Ù†Ø¬Ø§Ø­ Ø§Ù„ÙØ­Øµ"
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Ø§Ù„ÙØ±Ø¹: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

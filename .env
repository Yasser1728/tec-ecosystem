// ============================================
// Secure Environment Loader
// ============================================
import 'dotenv/config'; // Ù„ØªØ­Ù…ÙŠÙ„ .env ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Local
import fs from 'fs';
import path from 'path';

// Helper: read env safely
function getEnv(key, fallback = '') {
    if (process.env[key]) return process.env[key];
    return fallback;
}

// ============================================
// Configuration
// ============================================
const CONFIG = {
    models: {
        gpt: getEnv('GPT_MODEL', 'openai/gpt-5.2-pro'),
        claude: getEnv('CLAUDE_MODEL', 'anthropic/claude-4.5-sonnet'),
        gemini: getEnv('GEMINI_MODEL', 'google/gemini-3-pro'),
        codex: getEnv('CODEX_MODEL', 'openai/gpt-5.1-codex-max'),
        deepseek: getEnv('DEEPSEEK_MODEL', 'deepseek/deepseek-r1:free'),
        llama: getEnv('LLAMA_MODEL', 'meta-llama/llama-3.1-405b-instruct:free'),
        qwen: getEnv('QWEN_MODEL', 'qwen/qwen3-coder-480b-a35b:free'),
        hermes: getEnv('HERMES_MODEL', 'nousresearch/hermes-3-llama-3.1-405b:free'),
        gpt_oss: getEnv('GPT_OSS_FREE', 'openai/gpt-oss-120b:free'),
        gemini_flash: getEnv('GEMINI_FLASH_FREE', 'google/gemini-2.0-flash:free'),
        o4: getEnv('O4_ENGINEER_MODEL', 'openai/o4-mini-high'),
        devstral: getEnv('DEVSTRAL_MODEL', 'mistralai/devstral-2-2512:free')
    },
    apiKey: getEnv('OPENROUTER_API_KEY', ''),
    servicesFolder: path.join(process.cwd(), 'ai-agent', 'services')
};

// Check critical keys
if (!CONFIG.apiKey) {
    console.error('âŒ OPENROUTER_API_KEY is missing! Set it in GitHub Secrets or .env');
    process.exit(1);
}

// ============================================
// Dynamic Service Loader
// ============================================
async function loadServices() {
    const services = [];
    try {
        const files = fs.readdirSync(CONFIG.servicesFolder);
        for (const file of files) {
            if (file.endsWith('.js')) {
                const servicePath = path.join(CONFIG.servicesFolder, file);
                try {
                    const module = await import(servicePath);
                    services.push({
                        name: path.basename(file, '.js'),
                        module
                    });
                    console.log(`âœ… Loaded service: ${file}`);
                } catch (err) {
                    console.warn(`âš ï¸ Failed to load ${file}: ${err.message}`);
                }
            }
        }
    } catch (err) {
        console.error(`âŒ Services folder not found: ${CONFIG.servicesFolder}`);
    }
    return services;
}

// ============================================
// Main Orchestrator
// ============================================
async function runSovereignServices() {
    console.log('ðŸš€ Sovereign OS Services Booting...');
    const services = await loadServices();
    console.log(`ðŸš€ Total services loaded: ${services.length}`);
    
    for (const svc of services) {
        if (svc.module && typeof svc.module.run === 'function') {
            try {
                await svc.module.run(CONFIG);
            } catch (err) {
                console.error(`âŒ Service ${svc.name} failed: ${err.message}`);
            }
        }
    }
}

if (import.meta.url === `file://${process.argv[1]}`) {
    runSovereignServices().catch(err => console.error('ðŸ’¥ Fatal:', err));
}

export { CONFIG, loadServices, runSovereignServices };
